---
title: "Data 2"
author: "Jessica Rizzo"
date: "2024-01-30"
output: pdf_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r echo=FALSE}
# Load packages
library(tidyverse)
library(priceR)
```

```{r echo=FALSE}
# Read-in data
hrs <- read.csv("/Users/jessicarizzo/Desktop/Project/1:29/hrs_new.csv")
```

In Waves 2 and 3 the 1993/1995 and 1994/1996 data are used interchangeably for different birth cohorts. To avoid this issue and, because some of the key variables were not recorded in Waves 1-3, we begin with Wave 4. Using the participants birth year (RABYEAR), we will create a new variable, AGE, which represents their age in 1998. For this reason, we remove one observation for which birth year is missing. 

We also create a set of new variables (HwWEALTH) which is the net value of non-housing financial wealth, corrected for debt: HwWEALTH = HwATOTF + HwADEBT. We will use HwWEALTH as our wealth measure going forward and drop HwATOTF and HwDEBT from the dataset as they are no longer needed. 

Finally, we use the package priceR to change RwOOPMD and HwWEALTH from nominal dollars to 2020 prices. The documentation of this package can be found here: https://search.r-project.org/CRAN/refmans/priceR/html/adjust_for_inflation.html

```{r echo=FALSE}
# For price adjustments - used later
country <- "US"
inflation_dataframe <- retrieve_inflation_data(country)
countries_dataframe <- show_countries()
```

```{r echo=FALSE}
# Create age variable (age in wave 4)
hrs <- mutate(hrs, AGE=1998-as.numeric(RABYEAR)) %>%
  # Delete observations where age is missing
  drop_na(AGE) %>%
  # Add back debt
  mutate(H4WEALTH=H4ATOTF+H4ADEBT) %>%
  mutate(H5WEALTH=H5ATOTF+H5ADEBT) %>%
  mutate(H6WEALTH=H6ATOTF+H6ADEBT) %>%
  mutate(H7WEALTH=H7ATOTF+H7ADEBT) %>%
  mutate(H8WEALTH=H8ATOTF+H8ADEBT) %>%
  mutate(H9WEALTH=H9ATOTF+H9ADEBT) %>%
  mutate(H10WEALTH=H10ATOTF+H10ADEBT) %>%
  mutate(H11WEALTH=H11ATOTF+H11ADEBT) %>%
  mutate(H12WEALTH=H12ATOTF+H12ADEBT) %>%
  mutate(H13WEALTH=H13ATOTF+H13ADEBT) %>%
  mutate(H14WEALTH=H14ATOTF+H14ADEBT) %>%
  mutate(H15WEALTH=H15ATOTF+H15ADEBT) %>%
  # Drop un-needed variables
  select(-c("H4ATOTF", "H4ADEBT")) %>%
  select(-c("H5ATOTF", "H5ADEBT")) %>%
  select(-c("H6ATOTF", "H6ADEBT")) %>%
  select(-c("H7ATOTF", "H7ADEBT")) %>%
  select(-c("H8ATOTF", "H8ADEBT")) %>%
  select(-c("H9ATOTF", "H9ADEBT")) %>%
  select(-c("H10ATOTF", "H10ADEBT")) %>%
  select(-c("H11ATOTF", "H11ADEBT")) %>%
  select(-c("H12ATOTF", "H12ADEBT")) %>%
  select(-c("H13ATOTF", "H13ADEBT")) %>%
  select(-c("H14ATOTF", "H14ADEBT")) %>%
  select(-c("H15ATOTF", "H15ADEBT")) %>%
  # To real dollars: OOPMD
  mutate(R4OOPMD=adjust_for_inflation(R4OOPMD, 1998, country, to_date = 2020, inflation_dataframe = inflation_dataframe, countries_dataframe = countries_dataframe)) %>%
  mutate(R5OOPMD=adjust_for_inflation(R5OOPMD, 2000, country, to_date = 2020, inflation_dataframe = inflation_dataframe, countries_dataframe = countries_dataframe)) %>%
  mutate(R6OOPMD=adjust_for_inflation(R6OOPMD, 2002, country, to_date = 2020, inflation_dataframe = inflation_dataframe, countries_dataframe = countries_dataframe)) %>%
  mutate(R7OOPMD=adjust_for_inflation(R7OOPMD, 2004, country, to_date = 2020, inflation_dataframe = inflation_dataframe, countries_dataframe = countries_dataframe)) %>%
  mutate(R8OOPMD=adjust_for_inflation(R8OOPMD, 2006, country, to_date = 2020, inflation_dataframe = inflation_dataframe, countries_dataframe = countries_dataframe)) %>%
  mutate(R9OOPMD=adjust_for_inflation(R9OOPMD, 2008, country, to_date = 2020, inflation_dataframe = inflation_dataframe, countries_dataframe = countries_dataframe)) %>%
  mutate(R10OOPMD=adjust_for_inflation(R10OOPMD, 2010, country, to_date = 2020, inflation_dataframe = inflation_dataframe, countries_dataframe = countries_dataframe)) %>%
  mutate(R11OOPMD=adjust_for_inflation(R11OOPMD, 2012, country, to_date = 2020, inflation_dataframe = inflation_dataframe, countries_dataframe = countries_dataframe)) %>%
  mutate(R12OOPMD=adjust_for_inflation(R12OOPMD, 2014, country, to_date = 2020, inflation_dataframe = inflation_dataframe, countries_dataframe = countries_dataframe)) %>%
  mutate(R13OOPMD=adjust_for_inflation(R13OOPMD, 2016, country, to_date = 2020, inflation_dataframe = inflation_dataframe, countries_dataframe = countries_dataframe)) %>%
  mutate(R14OOPMD=adjust_for_inflation(R14OOPMD, 2018, country, to_date = 2020, inflation_dataframe = inflation_dataframe, countries_dataframe = countries_dataframe)) %>%
  # To real dollars: WEALTH
  mutate(H4WEALTH=adjust_for_inflation(H4WEALTH, 1998, country, to_date = 2020, inflation_dataframe = inflation_dataframe, countries_dataframe = countries_dataframe)) %>%
  mutate(H5WEALTH=adjust_for_inflation(H5WEALTH, 2000, country, to_date = 2020, inflation_dataframe = inflation_dataframe, countries_dataframe = countries_dataframe)) %>%
  mutate(H6WEALTH=adjust_for_inflation(H6WEALTH, 2002, country, to_date = 2020, inflation_dataframe = inflation_dataframe, countries_dataframe = countries_dataframe)) %>%
  mutate(H7WEALTH=adjust_for_inflation(H7WEALTH, 2004, country, to_date = 2020, inflation_dataframe = inflation_dataframe, countries_dataframe = countries_dataframe)) %>%
  mutate(H8WEALTH=adjust_for_inflation(H8WEALTH, 2006, country, to_date = 2020, inflation_dataframe = inflation_dataframe, countries_dataframe = countries_dataframe)) %>%
 mutate(H9WEALTH=adjust_for_inflation(H9WEALTH, 2008, country, to_date = 2020, inflation_dataframe = inflation_dataframe, countries_dataframe = countries_dataframe)) %>%
  mutate(H10WEALTH=adjust_for_inflation(H10WEALTH, 2010, country, to_date = 2020, inflation_dataframe = inflation_dataframe, countries_dataframe = countries_dataframe)) %>%
  mutate(H11WEALTH=adjust_for_inflation(H11WEALTH, 2012, country, to_date = 2020, inflation_dataframe = inflation_dataframe, countries_dataframe = countries_dataframe)) %>%
  mutate(H12WEALTH=adjust_for_inflation(H12WEALTH, 2014, country, to_date = 2020, inflation_dataframe = inflation_dataframe, countries_dataframe = countries_dataframe)) %>%
  mutate(H13WEALTH=adjust_for_inflation(H13WEALTH, 2016, country, to_date = 2020, inflation_dataframe = inflation_dataframe, countries_dataframe = countries_dataframe)) %>%
  mutate(H14WEALTH=adjust_for_inflation(H14WEALTH, 2018, country, to_date = 2020, inflation_dataframe = inflation_dataframe, countries_dataframe = countries_dataframe)) %>%
# Drop dentist
  select(-c("R7DENTST", "R8DENTST", "R9DENTST", "R10DENTST", "R11DENTST", "R12DENTST", "R13DENTST", "R14DENTST", "R15DENTST")) %>%
  mutate(R15WTRESP = rep(NA, 42405))
```

The time variable in the HRS dataset is wave. We are interested in the effect of age on spending so we will need to re-organize the data. To do so, we build a function 'get_wave(w)' to pull all of the variables (with HHIDPN and AGE added on) associated with wave w. 

```{r echo=FALSE}
# Build a function given a wave to pull all of the variables associated with that wave
vars <- colnames(hrs)
get_wave <- function(w){
  # Select variables
  vars_w <- grep(w, vars)
  # If w = 1-5, remove 11-15
  if(w <= 5){
    vars_not_needed <- grep(w+10, vars)
    vars_w <- setdiff(vars_w, vars_not_needed)
  }
  # Add in HHIDPN, Age
  vars_w <- c(1, 215, vars_w)
  # Get data
  subset <- hrs[,vars_w]
  colnames(subset) <- c("HHIDPN", "AGE", "WEIGHT", "HEALTH_CHANGE", "NEW_CONDS", "HOSP", "NRS_HOME", "DOCTOR", "OUT_PT", "DRUGS", "HOME_CARE", "SPECIAL_FAC", "SPENDING", "SOCIAL", "ISSI", "MEDICARE", "WEALTH")
  return(subset)
}
```

Our target dataset will be in the following "long" format:  

HHIDPN   AGE   WEIGHT   HEALTH VARIABLES     ....
  1234    65    1000                   X     ....
  1234    67    1002                   Y     ....
  
To achieve this, we will cycle through each HHIDPN and each wave and enter an observation for a specific HHIDPN and wave (age) into our target dataset if it meets the following criteria:

(1) Age >= 65
(2) Medicare == "1.Yes"
(3) HwWEALTH >= 1000

```{r echo=FALSE}
# Set up output dataset in long format
final_long <- as.data.frame(matrix(rep(NA, 17), 1, 17))
colnames(final_long) <-c("HHIDPN", "AGE", "WEIGHT", "HEALTH_CHANGE", "NEW_CONDS", "HOSP", "NRS_HOME", "DOCTOR", "OUT_PT", "DRUGS", "HOME_CARE", "SPECIAL_FAC", "SPENDING", "SOCIAL", "ISSI", "MEDICARE", "WEALTH")
n <- dim(hrs)[1]
k <- 1
# Cycle through each observation
for(i in 1:n){
  # Cycle through each wave
  for(j in 4:15){
    wave_data <- get_wave(j)[i,]
    # Find age in this cycle
    age <- wave_data$AGE + (j - 4)*2
    if(!is.na(wave_data$MEDICARE) && !is.na(age) && !is.na(wave_data$WEALTH)){
      if(wave_data$MEDICARE == "1.Yes" && age >= 65 && wave_data$WEALTH >= 1000){
      wave_data$AGE <- age
      final_long[k, ] <- wave_data
      k <- k + 1
    } 
    }
  }
}
# Unique obs
length(unique(final_long$HHIDPN))
```

Now, we subset this data to identify individuals who were observed with the criteria beginning at age 65. Since an individual is either observed at "even" or "odd" years of their age, we consider: 65, 67, 69 and 66, 68, 70. Since an observation includes the previous two years, an individual observed at AGE=66 will include their "65" data. 

```{r echo=FALSE}
# Start at age 65
ids_65 <- subset(final_long$HHIDPN, final_long$AGE==65)
at_65 <- subset(final_long, final_long$HHIDPN %in% ids_65)
ids_67 <- subset(at_65$HHIDPN, at_65$AGE==67)
at_67 <- subset(at_65, at_65$HHIDPN %in% ids_67)
ids_69 <- subset(at_67$HHIDPN, at_67$AGE==69)
at_69 <- subset(at_67, at_67$HHIDPN %in% ids_69)
at_69 <- subset(at_69, at_69$AGE <=69)
cat("Obs 65-69:\n")
length(at_69$HHIDPN)/3
at_67 <- subset(at_67, at_67$AGE <= 67)
cat("Obs 65-67:\n")
length(at_67$HHIDPN)/2
```

```{r echo=FALSE}
# Start at age 66 
ids_66 <- subset(final_long$HHIDPN, final_long$AGE==66)
at_66 <- subset(final_long, final_long$HHIDPN %in% ids_66)
ids_68 <- subset(at_66$HHIDPN, at_66$AGE==68)
at_68 <- subset(at_66, at_66$HHIDPN %in% ids_68)
ids_70 <- subset(at_68$HHIDPN, at_68$AGE==70)
at_70 <- subset(at_68, at_68$HHIDPN %in% ids_70)
at_70 <- subset(at_70, at_70$AGE <=70)
cat("Obs 66-70:\n")
length(at_70$HHIDPN)/3
at_68 <- subset(at_68, at_68$AGE <= 68)
cat("Obs 66-68:\n")
length(at_68$HHIDPN)/2
```

While subsetting, we noticed that there are significantly more "67" observations that "65" so we will also consider the progression 67, 69, 71. 

```{r echo=FALSE}
# What if start at age 67
ids_67 <- subset(final_long$HHIDPN, final_long$AGE==67)
at_67 <- subset(final_long, final_long$HHIDPN %in% ids_67)
ids_69 <- subset(at_67$HHIDPN, at_67$AGE==69)
at_69 <- subset(at_67, at_67$HHIDPN %in% ids_69)
at_69 <- subset(at_69, at_69$AGE >= 67)
ids_71 <- subset(at_69$HHIDPN, at_69$AGE==71)
at_71 <- subset(at_69, at_69$HHIDPN %in% ids_71)
at_71 <- subset(at_71, at_71$AGE <=71)
cat("Obs 67-71:\n")
length(at_71$HHIDPN)/3
at_69 <- subset(at_69, at_69$AGE <= 69)
cat("Obs 67-69:\n")
length(at_69$HHIDPN)/2
```




