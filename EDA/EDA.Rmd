---
title: "Results from Preliminary Analysis of Selected HRS Variables"
author: ""
date: "Friday January 26th, 2024"
output: pdf_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r include=FALSE}
## PACKAGES
library(tidyverse)
library(gtools)
library(stringi)
library(ggplot2)
library(dplyr)
library(gridExtra)
```

## Scaling Out-Of-Pocket Spending ##

To investigate the effect of the selected health variables on out-of-pocket medical spending, we use a smaller dataset comprised of 5000 randomly selected observations (HHIDPNs). We will look for those variables most associated with high values of out-of-pocket spending (RwOOPMD). Out-of-pocket spending is reported in nominal dollars which should be scaled by either social security income (RwISSI) or household net-value of non-housing financial wealth (HwATOTF). We compute two new variables for each wave:

- RwOOPAT: out-of-pocket medical spending as a percentage of non-housing financial wealth
- RwOOPSS: out-of-pocket medical spending as a percentage of social security income

However, the creation of these variables presented two problems. The first is, that many individuals have large negative values for non-housing financial wealth, which we interpreted to signify debt. Below is the descriptive statistics for the HwATOTF variables from the HRS Data Documentation:  

Figure 1: Descriptive Statistics for HwATOTF  
<center>

![](/Users/jessicarizzo/Desktop/Project/HwATOTF_descriptive_stat.png)

</center>
  
It may be more useful to handle these "in-debt" individuals separately or to stratify the data into wealth categories. Additionally, there are many observations (approximately half of the 5000 randomly selected) for which RwISSI is zero and a smaller, but still significant, percentage for which HwATAOTF is zero. Given these issues we will ignore the problem of scaling for now and thus, the figures below are presented in nominal dollars. However, this analysis can (and will) be redone with the scaled values of out-of-pocket spending.    

```{r include=FALSE, warning=FALSE}
## READ-IN DATA
hrs <- read.csv("/Users/jessicarizzo/Desktop/Project/hrs_sample.csv") %>%
# ADD-REMOVE VARIABLES
## OOPMD 2
select(-c("R2OOPMD")) %>%

## OOPAT = OOPMD as % of ATOTF
  mutate("R3OOPAT" = `R3OOPMD`/`H3ATOTF`*100) %>%
  mutate("R4OOPAT" = `R4OOPMD`/`H4ATOTF`*100) %>%
  mutate("R5OOPAT" = `R5OOPMD`/`H5ATOTF`*100) %>%
  mutate("R6OOPAT" = `R6OOPMD`/`H6ATOTF`*100) %>%
  mutate("R7OOPAT" = `R7OOPMD`/`H7ATOTF`*100) %>%
  mutate("R8OOPAT" = `R8OOPMD`/`H8ATOTF`*100) %>%
  mutate("R9OOPAT" = `R9OOPMD`/`H9ATOTF`*100) %>%
  mutate("R10OOPAT" = `R10OOPMD`/`H10ATOTF`*100) %>%
  mutate("R11OOPAT" = `R11OOPMD`/`H11ATOTF`*100) %>%
  mutate("R12OOPAT" = `R12OOPMD`/`H12ATOTF`*100) %>%
  mutate("R13OOPAT" = `R13OOPMD`/`H13ATOTF`*100) %>%
  mutate("R14OOPAT" = `R14OOPMD`/`H14ATOTF`*100) %>%
  mutate("R15OOPAT" = `R15OOPMD`/`H15ATOTF`*100) %>%

## OOPSS = OOPMD as % of ISSI
  mutate("R3OOPSS" = `R3OOPMD`/`R3ISSI`*100) %>%
  mutate("R4OOPSS" = `R4OOPMD`/`R4ISSI`*100) %>%
  mutate("R5OOPSS" = `R5OOPMD`/`R5ISSI`*100) %>%
  mutate("R6OOPSS" = `R6OOPMD`/`R6ISSI`*100) %>%
  mutate("R7OOPSS" = `R7OOPMD`/`R7ISSI`*100) %>%
  mutate("R8OOPSS" = `R8OOPMD`/`R8ISSI`*100) %>%
  mutate("R9OOPSS" = `R9OOPMD`/`R9ISSI`*100) %>%
  mutate("R10OOPSS" = `R10OOPMD`/`R10ISSI`*100) %>%
  mutate("R11OOPSS" = `R11OOPMD`/`R11ISSI`*100) %>%
  mutate("R12OOPSS" = `R12OOPMD`/`R12ISSI`*100) %>%
  mutate("R13OOPSS" = `R13OOPMD`/`R13ISSI`*100) %>%
  mutate("R14OOPSS" = `R14OOPMD`/`R14ISSI`*100) %>%
  mutate("R15OOPSS" = `R15OOPMD`/`R15ISSI`*100)
```
  
```{r include=FALSE}
## INIT
n_var <- dim(hrs)[2]
n_obs <- dim(hrs)[1]
vars <- colnames(hrs)
```

```{r include=FALSE}
## FUNCTIONS

### For example if calling wave_x_var("OOPMD") this function would return a dataset
### in the form of:
### HHIDPN    Wave 1     Wave 2     ....
### 1234      OOPMD      OOPMD      ....

var_abbrev <- "OOPSS"
wave_x_var <- function(var_abbrev){
  # Subset the data to the relavent variables
  new <- hrs[,c(1, grep(var_abbrev, vars)[mixedorder(vars[grep(var_abbrev, vars)])])]
  # Identify any missing waves and add columns of NAs
  waves_present <- as.numeric(stri_sub(colnames(new)[-1], 2, -(nchar(var_abbrev)+1)))
  waves_missing <- which(is.na(match(1:15, waves_present)))
  if(length(waves_missing) > 0){
    for(i in waves_missing){
      new <- add_column(new, i = rep(NA, 5000), .after=i)
    }
  }
  # Replace column names
  colnames(new)[-1] <- paste(var_abbrev, 1:15)
  # Return new dataset
  return(new)
}
```

## Medicare Coverage ##

  Our analysis will focus on HRS participants who are covered by Medicare. We will use the variable(s) 'RwGOVMR' to determine Medicare status in each wave. A participant in a given wave is eligible for analysis if RwGOVMR = "1.Yes." All other observations will be ignored. From the 5000 randomly selected observations, we will look for individuals with 10 consecutive years of Medicare coverage from Waves 4-13 (where the majority of our variables of interest are collected). For future analysis, we must decide how many years of Medicare coverage an individual must have to be eligible for our sample and how we will handle observations for which one or more years are missing.  

```{r include=FALSE, warning=FALSE}
# LIMIT TO MEDICARE
medicare <- wave_x_var("GOVMR") %>%
  # True/False
  mutate(across(is.character, ~replace(.x, .x=="1.Yes", TRUE)))  %>%
  mutate(across(is.character, ~replace(.x, .x!="TRUE", FALSE))) %>%
  mutate(across(is.character, as.logical))
# Find True locations
where_t <- which(medicare==TRUE, arr.ind=TRUE)

# Observations with 10 consecutive years of Medicare
t1 <- subset(medicare, medicare$`GOVMR 4`==TRUE)
t2 <- subset(t1, t1$`GOVMR 5`==TRUE)
t3 <- subset(t2, t2$`GOVMR 6`==TRUE)
t4 <- subset(t3, t3$`GOVMR 7`==TRUE)
t5 <- subset(t4, t4$`GOVMR 8`==TRUE)
t6 <- subset(t5, t5$`GOVMR 9`==TRUE)
t7 <- subset(t6, t6$`GOVMR 10`==TRUE)
t8 <- subset(t7, t7$`GOVMR 11`==TRUE)
t9 <- subset(t8, t8$`GOVMR 12`==TRUE)
t10 <- subset(t9, t9$`GOVMR 13`==TRUE)
```

## Analysis of Selected Variables ##
This gives us a selection of 203 participants with very complete data to look at. We begin by examining the effect of gaining a new diagnosis (RwCONDS) on out-of-pocket medical spending (RwOOPMD). The included diseases are: *high blood pressure, diabetes, cancer, lung disease, heart disease, stroke, psychiatric problems and arthritis.* The most common values of RwCONDS are 0, 1, and 2. Responses of 3 are present but very rare. Responses of 4 and 5 and not present in this sample and are relatively rare in the overall dataset. For each wave, we calculate the average out-of-pocket spending stratified by the value of RwCONDS. The results are plotted below. 

Figure 2: Out-of-Pocket Medical Spending Stratified by RwCONDS  
```{r echo=FALSE, warning=FALSE, fig.height=4, fig.width=5, fig.align='center'}
# RCONDS
new1  <- wave_x_var("OOPMD") %>%
  mutate(across(is.numeric, ~replace(.x, .x==Inf, 0))) %>%
  mutate(across(is.numeric, ~replace(.x, is.nan(.x)==TRUE, 0)))
new2 <- wave_x_var("CONDS")[,-1]
new <- cbind(new2, new1)
new_med <- subset(new, !is.na(match(new$HHIDPN, t10$HHIDPN))==TRUE) %>%
  select(-c("OOPMD 1","OOPMD 2", "OOPMD 14", "OOPMD 15", "CONDS 1", "CONDS 2", "CONDS 3", "CONDS 14", "CONDS 15"))
## Dataset for plotting
plot <- as.data.frame(matrix(rep(NA, 120), 40, 3)) 
colnames(plot) <- c("CONDS", "Year", "Value")
k <- 1
for(i in 4:13){
  year_sub <- select(new_med, ends_with(as.character(i)))
  for(j in 0:3){
    conds_sub <- subset(year_sub, year_sub[,1]==j)
    plot[k,] <- c(j, i, mean(conds_sub[,2], na.rm=TRUE))
    k <- k + 1
  }
}

## Plot
plot$Value[is.na(plot$Value)] <- 0
plot$CONDS <- as.character(plot$CONDS)
ggplot(plot, aes(x=Year, y=Value, fill=CONDS)) + geom_area()
```

If RwCONDS was a good predictor of high out-of-pocket medical spending, we would expect to see that band width increases with the value of RwCONDS. This appears to be true to some degree, but this plot does not account for age of the participants. While the age of each individual participant increases with each consecutive wave, the age of participants is not constant across waves. To hold age constant, we will further restrict our sample to individuals who were 64 in wave 4 (the most common age) and redo the above plot for these individuals. 

Figure 3: Out-of-Pocket Medical Spending Stratified by RwCONDS and Adjusted for Age

```{r echo=FALSE, fig.height=4, fig.width=5, fig.align='center'}
## Add in age
new_med_age <- add_column(new_med,"Age" = 1996 - as.numeric(subset(hrs, !is.na(match(hrs$HHIDPN, new_med$HHIDPN))==TRUE)$RABYEAR)) %>% 
  subset(Age == 64)

## Re-plot
plot <- as.data.frame(matrix(rep(NA, 120), 40, 3)) 
colnames(plot) <- c("CONDS", "Year", "Value")
k <- 1
for(i in 4:13){
  year_sub <- select(new_med_age, ends_with(as.character(i)))
  for(j in 0:3){
    conds_sub <- subset(year_sub, year_sub[,1]==j)
    plot[k,] <- c(j, i, mean(conds_sub[,2], na.rm=TRUE))
    k <- k + 1
  }
}

plot$Value[is.na(plot$Value)] <- 0
plot$CONDS <- as.character(plot$CONDS)
ggplot(plot, aes(x=Year, y=Value, fill=CONDS)) + geom_area()
```

We expect that as age increases, a new diagnosis would have a greater impact on spending, as changes in health tend to have a greater impact on older people. On the other hand, this may be strictly true. For example, cancer would likely cause a large spike in spending at any age. This plot also doesn't account for the discrepancy in severity between the included diseases (cancer vs. arthritis) or pre-existing conditions of participants. We could consider including the specific indicator variables for each disease or pre-existing conditions; however, this would greatly increase the complexity of our future model.  

We will repeat this analysis for self-report of health change (RwSHLTC). Higher values indicate greater deterioration. Values (-4) through 4 are most common and values -5 and 5 are not present in this sample and relatively rare overall. Here, band-width more clearly appears to increase with the value of health-change. 

Figure 4: Out-of-Pocket Medical Spending Stratified by RwSHLTC

```{r echo=FALSE, fig.height=4, fig.width=5, fig.align='center'}
# SHLTC
new1  <- wave_x_var("OOPMD") %>%
  mutate(across(is.numeric, ~replace(.x, .x==Inf, 0))) %>%
  mutate(across(is.numeric, ~replace(.x, is.nan(.x)==TRUE, 0)))
new2 <- wave_x_var("SHLTC")[,-1]
new <- cbind(new2, new1)
new_med <- subset(new, !is.na(match(new$HHIDPN, t10$HHIDPN))==TRUE) %>%
  select(-c("OOPMD 1","OOPMD 2", "OOPMD 14", "OOPMD 15", "SHLTC 1", "SHLTC 2", "SHLTC 3", "SHLTC 14", "SHLTC 15"))
## Dataset for plotting
plot <- as.data.frame(matrix(rep(NA, 270), 90, 3)) 
colnames(plot) <- c("SHLTC", "Year", "Value")
k <- 1
for(i in 4:13){
  year_sub <- select(new_med, ends_with(as.character(i)))
  for(j in -4:4){
    shltc_sub <- subset(year_sub, year_sub[,1]==j)
    plot[k,] <- c(j, i, mean(shltc_sub[,2], na.rm=TRUE))
    k <- k + 1
  }
}

## Plot
plot$Value[is.na(plot$Value)] <- 0
plot$SHLTC <- as.character(plot$SHLTC)
ggplot(plot, aes(x=Year, y=Value, fill=SHLTC)) + geom_area()

```

Here is the plot for starting Age=64. Since there are less observations the distribution is more volatile.   

Figure 5: Out-of-Pocket Medical Spending Stratified by RwSHLTC and Adjusted for Age
 
```{r echo=FALSE, fig.height=4, fig.width=5, fig.align='center'}
## Add in age
new_med_age <- add_column(new_med,"Age" = 1996 - as.numeric(subset(hrs, !is.na(match(hrs$HHIDPN, new_med$HHIDPN))==TRUE)$RABYEAR)) %>%
  subset(Age == 64)

## Re-plot
plot <- as.data.frame(matrix(rep(NA, 270), 90, 3)) 
colnames(plot) <- c("SHLTC", "Year", "Value")
k <- 1
for(i in 4:13){
  year_sub <- select(new_med_age, ends_with(as.character(i)))
  for(j in -4:4){
    shltc_sub <- subset(year_sub, year_sub[,1]==j)
    plot[k,] <- c(j, i, mean(shltc_sub[,2], na.rm=TRUE))
    k <- k + 1
  }
}

plot$Value[is.na(plot$Value)] <- 0
plot$SHLTC <- as.character(plot$SHLTC)
ggplot(plot, aes(x=Year, y=Value, fill=SHLTC)) + geom_area()
```

We can similarly plot the remaining health variables: use of hospital (RwHOSP), nursing home (RwNRSHOM), doctor (RwDOCTOR), home care (RwHOMCAR), medication (RwDRUGS), outpatient care (RwOUTPT), or special facility (RwSPCFAC). We we will not include dentist (RwDENTST) as it is only present from wave 7 onward or hospice (REHPCSTY) as it is an exit variable.  

Figure 6: (Left) Out-of-Pocket Medical Spending Stratified by Hospital Use (Right) Adjusted for Age  

```{r fig.height=4, fig.width=10, echo=FALSE, fig.align='center'}
# HOSP
new1  <- wave_x_var("OOPMD") %>%
  mutate(across(is.numeric, ~replace(.x, .x==Inf, 0))) %>%
  mutate(across(is.numeric, ~replace(.x, is.nan(.x)==TRUE, 0)))
new2 <- wave_x_var("HOSP")[,-1] %>%
    mutate(across(is.character, ~replace(.x, .x=="1.Yes", TRUE)))  %>%
    mutate(across(is.character, ~replace(.x, .x!="TRUE", FALSE)))  %>%
    mutate(across(is.character, as.logical))
new <- cbind(new2, new1)
new_med <- subset(new, !is.na(match(new$HHIDPN, t10$HHIDPN))==TRUE) %>%
  select(-c("OOPMD 1","OOPMD 2", "OOPMD 14", "OOPMD 15", "HOSP 1", "HOSP 2", "HOSP 3", "HOSP 14", "HOSP 15"))

## Dataset for plotting
plot <- as.data.frame(matrix(rep(NA, 60), 20, 3)) 
colnames(plot) <- c("HOSP", "Year", "Value")
k <- 1
for(i in 4:13){
  year_sub <- select(new_med, ends_with(as.character(i)))
  for(j in 0:1){
    HOSP_sub <- subset(year_sub, year_sub[,1]==j)
    plot[k,] <- c(j, i, mean(HOSP_sub[,2], na.rm=TRUE))
    k <- k + 1
  }
}

## Plot
plot$Value[is.na(plot$Value)] <- 0
plot$HOSP <- as.character(plot$HOSP)
plot1 <- ggplot(plot, aes(x=Year, y=Value, fill=HOSP)) + geom_area()

## Add in age
new_med_age <- add_column(new_med,"Age" = 1996 - as.numeric(subset(hrs, !is.na(match(hrs$HHIDPN, new_med$HHIDPN))==TRUE)$RABYEAR)) %>%
  subset(Age == 64)

## Re-plot
plot <- as.data.frame(matrix(rep(NA, 60), 20, 3)) 
colnames(plot) <- c("HOSP", "Year", "Value")
k <- 1
for(i in 4:13){
  year_sub <- select(new_med_age, ends_with(as.character(i)))
  for(j in 0:1){
    HOSP_sub <- subset(year_sub, year_sub[,1]==j)
    plot[k,] <- c(j, i, mean(HOSP_sub[,2], na.rm=TRUE))
    k <- k + 1
  }
}

plot$Value[is.na(plot$Value)] <- 0
plot$HOSP <- as.factor(plot$HOSP)
plot2 <- ggplot(plot, aes(x=Year, y=Value, fill=HOSP)) + geom_area()

grid.arrange(plot1, plot2, ncol=2)
```

Figure 7: (Left) Out-of-Pocket Medical Spending Stratified by Nursing Home Use (Right) Adjusted for Age  

```{r fig.height=4, fig.width=10, echo=FALSE, fig.align='center'}
# NRSHOM
new1  <- wave_x_var("OOPMD") %>%
  mutate(across(is.numeric, ~replace(.x, .x==Inf, 0))) %>%
  mutate(across(is.numeric, ~replace(.x, is.nan(.x)==TRUE, 0)))
new2 <- wave_x_var("NRSHOM")[,-1] %>%
    mutate(across(is.character, ~replace(.x, .x=="1.Yes", TRUE)))  %>%
    mutate(across(is.character, ~replace(.x, .x!="TRUE", FALSE)))  %>%
    mutate(across(is.character, as.logical))
new <- cbind(new2, new1)
new_med <- subset(new, !is.na(match(new$HHIDPN, t10$HHIDPN))==TRUE) %>%
  select(-c("OOPMD 1","OOPMD 2", "OOPMD 14", "OOPMD 15", "NRSHOM 1", "NRSHOM 2", "NRSHOM 3", "NRSHOM 14", "NRSHOM 15"))

## Dataset for plotting
plot <- as.data.frame(matrix(rep(NA, 60), 20, 3)) 
colnames(plot) <- c("NRSHOM", "Year", "Value")
k <- 1
for(i in 4:13){
  year_sub <- select(new_med, ends_with(as.character(i)))
  for(j in 0:1){
    NRSHOM_sub <- subset(year_sub, year_sub[,1]==j)
    plot[k,] <- c(j, i, mean(NRSHOM_sub[,2], na.rm=TRUE))
    k <- k + 1
  }
}

## Plot
plot$Value[is.na(plot$Value)] <- 0
plot$NRSHOM <- as.character(plot$NRSHOM)
plot1 <- ggplot(plot, aes(x=Year, y=Value, fill=NRSHOM)) + geom_area()

## Add in age
new_med_age <- add_column(new_med,"Age" = 1996 - as.numeric(subset(hrs, !is.na(match(hrs$HHIDPN, new_med$HHIDPN))==TRUE)$RABYEAR)) %>%
  subset(Age == 64)

## Re-plot
plot <- as.data.frame(matrix(rep(NA, 60), 20, 3)) 
colnames(plot) <- c("NRSHOM", "Year", "Value")
k <- 1
for(i in 4:13){
  year_sub <- select(new_med_age, ends_with(as.character(i)))
  for(j in 0:1){
    NRSHOM_sub <- subset(year_sub, year_sub[,1]==j)
    plot[k,] <- c(j, i, mean(NRSHOM_sub[,2], na.rm=TRUE))
    k <- k + 1
  }
}

plot$Value[is.na(plot$Value)] <- 0
plot$NRSHOM <- as.factor(plot$NRSHOM)
plot2 <- ggplot(plot, aes(x=Year, y=Value, fill=NRSHOM)) + geom_area()

grid.arrange(plot1, plot2, ncol=2)
```

Figure 8: (Left) Out-of-Pocket Medical Spending Stratified by Doctor Use (Right) Adjusted for Age  

```{r fig.height=4, fig.width=10, echo=FALSE, fig.align='center'}
# DOCTOR
new1  <- wave_x_var("OOPMD") %>%
  mutate(across(is.numeric, ~replace(.x, .x==Inf, 0))) %>%
  mutate(across(is.numeric, ~replace(.x, is.nan(.x)==TRUE, 0)))
new2 <- wave_x_var("DOCTOR")[,-1] %>%
    mutate(across(is.character, ~replace(.x, .x=="1.Yes", TRUE)))  %>%
    mutate(across(is.character, ~replace(.x, .x!="TRUE", FALSE)))  %>%
    mutate(across(is.character, as.logical))
new <- cbind(new2, new1)
new_med <- subset(new, !is.na(match(new$HHIDPN, t10$HHIDPN))==TRUE) %>%
  select(-c("OOPMD 1","OOPMD 2", "OOPMD 14", "OOPMD 15", "DOCTOR 1", "DOCTOR 2", "DOCTOR 3", "DOCTOR 14", "DOCTOR 15"))

## Dataset for plotting
plot <- as.data.frame(matrix(rep(NA, 60), 20, 3)) 
colnames(plot) <- c("DOCTOR", "Year", "Value")
k <- 1
for(i in 4:13){
  year_sub <- select(new_med, ends_with(as.character(i)))
  for(j in 0:1){
    DOCTOR_sub <- subset(year_sub, year_sub[,1]==j)
    plot[k,] <- c(j, i, mean(DOCTOR_sub[,2], na.rm=TRUE))
    k <- k + 1
  }
}

## Plot
plot$Value[is.na(plot$Value)] <- 0
plot$DOCTOR <- as.character(plot$DOCTOR)
plot1 <- ggplot(plot, aes(x=Year, y=Value, fill=DOCTOR)) + geom_area()

## Add in age
new_med_age <- add_column(new_med,"Age" = 1996 - as.numeric(subset(hrs, !is.na(match(hrs$HHIDPN, new_med$HHIDPN))==TRUE)$RABYEAR)) %>%
  subset(Age == 64)

## Re-plot
plot <- as.data.frame(matrix(rep(NA, 60), 20, 3)) 
colnames(plot) <- c("DOCTOR", "Year", "Value")
k <- 1
for(i in 4:13){
  year_sub <- select(new_med_age, ends_with(as.character(i)))
  for(j in 0:1){
    DOCTOR_sub <- subset(year_sub, year_sub[,1]==j)
    plot[k,] <- c(j, i, mean(DOCTOR_sub[,2], na.rm=TRUE))
    k <- k + 1
  }
}

plot$Value[is.na(plot$Value)] <- 0
plot$DOCTOR <- as.factor(plot$DOCTOR)
plot2 <- ggplot(plot, aes(x=Year, y=Value, fill=DOCTOR)) + geom_area()

grid.arrange(plot1, plot2, ncol=2)
```

Figure 9: (Left) Out-of-Pocket Medical Spending Stratified by Homecare Use (Right) Adjusted for Age   

```{r fig.height=4, fig.width=10, echo=FALSE, fig.align='center'}
# HOMCAR
new1  <- wave_x_var("OOPMD") %>%
  mutate(across(is.numeric, ~replace(.x, .x==Inf, 0))) %>%
  mutate(across(is.numeric, ~replace(.x, is.nan(.x)==TRUE, 0)))
new2 <- wave_x_var("HOMCAR")[,-1] %>%
    mutate(across(is.character, ~replace(.x, .x=="1.Yes", TRUE)))  %>%
    mutate(across(is.character, ~replace(.x, .x!="TRUE", FALSE)))  %>%
    mutate(across(is.character, as.logical))
new <- cbind(new2, new1)
new_med <- subset(new, !is.na(match(new$HHIDPN, t10$HHIDPN))==TRUE) %>%
  select(-c("OOPMD 1","OOPMD 2", "OOPMD 14", "OOPMD 15", "HOMCAR 1", "HOMCAR 2", "HOMCAR 3", "HOMCAR 14", "HOMCAR 15"))

## Dataset for plotting
plot <- as.data.frame(matrix(rep(NA, 60), 20, 3)) 
colnames(plot) <- c("HOMCAR", "Year", "Value")
k <- 1
for(i in 4:13){
  year_sub <- select(new_med, ends_with(as.character(i)))
  for(j in 0:1){
    HOMCAR_sub <- subset(year_sub, year_sub[,1]==j)
    plot[k,] <- c(j, i, mean(HOMCAR_sub[,2], na.rm=TRUE))
    k <- k + 1
  }
}

## Plot
plot$Value[is.na(plot$Value)] <- 0
plot$HOMCAR <- as.character(plot$HOMCAR)
plot1 <- ggplot(plot, aes(x=Year, y=Value, fill=HOMCAR)) + geom_area()

## Add in age
new_med_age <- add_column(new_med,"Age" = 1996 - as.numeric(subset(hrs, !is.na(match(hrs$HHIDPN, new_med$HHIDPN))==TRUE)$RABYEAR)) %>%
  subset(Age == 64)

## Re-plot
plot <- as.data.frame(matrix(rep(NA, 60), 20, 3)) 
colnames(plot) <- c("HOMCAR", "Year", "Value")
k <- 1
for(i in 4:13){
  year_sub <- select(new_med_age, ends_with(as.character(i)))
  for(j in 0:1){
    HOMCAR_sub <- subset(year_sub, year_sub[,1]==j)
    plot[k,] <- c(j, i, mean(HOMCAR_sub[,2], na.rm=TRUE))
    k <- k + 1
  }
}

plot$Value[is.na(plot$Value)] <- 0
plot$HOMCAR <- as.factor(plot$HOMCAR)
plot2 <- ggplot(plot, aes(x=Year, y=Value, fill=HOMCAR)) + geom_area()

grid.arrange(plot1, plot2, ncol=2)
```

Figure 10: (Left) Out-of-Pocket Medical Spending Stratified by Drug Use (Right) Adjusted for Age  

```{r fig.height=4, fig.width=10, echo=FALSE, fig.align='center'}
# DRUGS
new1  <- wave_x_var("OOPMD") %>%
  mutate(across(is.numeric, ~replace(.x, .x==Inf, 0))) %>%
  mutate(across(is.numeric, ~replace(.x, is.nan(.x)==TRUE, 0)))
new2 <- wave_x_var("DRUGS")[,-1] %>%
    mutate(across(is.character, ~replace(.x, .x=="1.Yes", TRUE)))  %>%
    mutate(across(is.character, ~replace(.x, .x!="TRUE", FALSE)))  %>%
    mutate(across(is.character, as.logical))
new <- cbind(new2, new1)
new_med <- subset(new, !is.na(match(new$HHIDPN, t10$HHIDPN))==TRUE) %>%
  select(-c("OOPMD 1","OOPMD 2", "OOPMD 14", "OOPMD 15", "DRUGS 1", "DRUGS 2", "DRUGS 3", "DRUGS 14", "DRUGS 15"))

## Dataset for plotting
plot <- as.data.frame(matrix(rep(NA, 60), 20, 3)) 
colnames(plot) <- c("DRUGS", "Year", "Value")
k <- 1
for(i in 4:13){
  year_sub <- select(new_med, ends_with(as.character(i)))
  for(j in 0:1){
    DRUGS_sub <- subset(year_sub, year_sub[,1]==j)
    plot[k,] <- c(j, i, mean(DRUGS_sub[,2], na.rm=TRUE))
    k <- k + 1
  }
}

## Plot
plot$Value[is.na(plot$Value)] <- 0
plot$DRUGS <- as.character(plot$DRUGS)
plot1 <- ggplot(plot, aes(x=Year, y=Value, fill=DRUGS)) + geom_area()

## Add in age
new_med_age <- add_column(new_med,"Age" = 1996 - as.numeric(subset(hrs, !is.na(match(hrs$HHIDPN, new_med$HHIDPN))==TRUE)$RABYEAR)) %>%
  subset(Age == 64)

## Re-plot
plot <- as.data.frame(matrix(rep(NA, 60), 20, 3)) 
colnames(plot) <- c("DRUGS", "Year", "Value")
k <- 1
for(i in 4:13){
  year_sub <- select(new_med_age, ends_with(as.character(i)))
  for(j in 0:1){
    DRUGS_sub <- subset(year_sub, year_sub[,1]==j)
    plot[k,] <- c(j, i, mean(DRUGS_sub[,2], na.rm=TRUE))
    k <- k + 1
  }
}

plot$Value[is.na(plot$Value)] <- 0
plot$DRUGS <- as.factor(plot$DRUGS)
plot2 <- ggplot(plot, aes(x=Year, y=Value, fill=DRUGS)) + geom_area()

grid.arrange(plot1, plot2, ncol=2)
```

Figure 11: (Left) Out-of-Pocket Medical Spending Stratified by Out-Patient Care Use (Right) Adjusted for Age   

```{r fig.height=4, fig.width=10, echo=FALSE, fig.align='center'}
# OUTPT
new1  <- wave_x_var("OOPMD") %>%
  mutate(across(is.numeric, ~replace(.x, .x==Inf, 0))) %>%
  mutate(across(is.numeric, ~replace(.x, is.nan(.x)==TRUE, 0)))
new2 <- wave_x_var("OUTPT")[,-1] %>%
    mutate(across(is.character, ~replace(.x, .x=="1.Yes", TRUE)))  %>%
    mutate(across(is.character, ~replace(.x, .x!="TRUE", FALSE)))  %>%
    mutate(across(is.character, as.logical))
new <- cbind(new2, new1)
new_med <- subset(new, !is.na(match(new$HHIDPN, t10$HHIDPN))==TRUE) %>%
  select(-c("OOPMD 1","OOPMD 2", "OOPMD 14", "OOPMD 15", "OUTPT 1", "OUTPT 2", "OUTPT 3", "OUTPT 14", "OUTPT 15"))

## Dataset for plotting
plot <- as.data.frame(matrix(rep(NA, 60), 20, 3)) 
colnames(plot) <- c("OUTPT", "Year", "Value")
k <- 1
for(i in 4:13){
  year_sub <- select(new_med, ends_with(as.character(i)))
  for(j in 0:1){
    OUTPT_sub <- subset(year_sub, year_sub[,1]==j)
    plot[k,] <- c(j, i, mean(OUTPT_sub[,2], na.rm=TRUE))
    k <- k + 1
  }
}

## Plot
plot$Value[is.na(plot$Value)] <- 0
plot$OUTPT <- as.character(plot$OUTPT)
plot1 <- ggplot(plot, aes(x=Year, y=Value, fill=OUTPT)) + geom_area()

## Add in age
new_med_age <- add_column(new_med,"Age" = 1996 - as.numeric(subset(hrs, !is.na(match(hrs$HHIDPN, new_med$HHIDPN))==TRUE)$RABYEAR)) %>%
  subset(Age == 64)

## Re-plot
plot <- as.data.frame(matrix(rep(NA, 60), 20, 3)) 
colnames(plot) <- c("OUTPT", "Year", "Value")
k <- 1
for(i in 4:13){
  year_sub <- select(new_med_age, ends_with(as.character(i)))
  for(j in 0:1){
    OUTPT_sub <- subset(year_sub, year_sub[,1]==j)
    plot[k,] <- c(j, i, mean(OUTPT_sub[,2], na.rm=TRUE))
    k <- k + 1
  }
}

plot$Value[is.na(plot$Value)] <- 0
plot$OUTPT <- as.factor(plot$OUTPT)
plot2 <- ggplot(plot, aes(x=Year, y=Value, fill=OUTPT)) + geom_area()

grid.arrange(plot1, plot2, ncol=2)
```

Figure 12: (Left) Out-of-Pocket Medical Spending Stratified by Special Facility Use (Right) Adjusted for Age   

```{r fig.height=4, fig.width=10, echo=FALSE, fig.align='center'}
# SPCFAC
new1  <- wave_x_var("OOPMD") %>%
  mutate(across(is.numeric, ~replace(.x, .x==Inf, 0))) %>%
  mutate(across(is.numeric, ~replace(.x, is.nan(.x)==TRUE, 0)))
new2 <- wave_x_var("SPCFAC")[,-1] %>%
    mutate(across(is.character, ~replace(.x, .x=="1.Yes", TRUE)))  %>%
    mutate(across(is.character, ~replace(.x, .x!="TRUE", FALSE)))  %>%
    mutate(across(is.character, as.logical))
new <- cbind(new2, new1)
new_med <- subset(new, !is.na(match(new$HHIDPN, t10$HHIDPN))==TRUE) %>%
  select(-c("OOPMD 1","OOPMD 2", "OOPMD 14", "OOPMD 15", "SPCFAC 1", "SPCFAC 2", "SPCFAC 3", "SPCFAC 14", "SPCFAC 15"))

## Dataset for plotting
plot <- as.data.frame(matrix(rep(NA, 60), 20, 3)) 
colnames(plot) <- c("SPCFAC", "Year", "Value")
k <- 1
for(i in 4:13){
  year_sub <- select(new_med, ends_with(as.character(i)))
  for(j in 0:1){
    SPCFAC_sub <- subset(year_sub, year_sub[,1]==j)
    plot[k,] <- c(j, i, mean(SPCFAC_sub[,2], na.rm=TRUE))
    k <- k + 1
  }
}

## Plot
plot$Value[is.na(plot$Value)] <- 0
plot$SPCFAC <- as.character(plot$SPCFAC)
plot1 <- ggplot(plot, aes(x=Year, y=Value, fill=SPCFAC)) + geom_area()

## Add in age
new_med_age <- add_column(new_med,"Age" = 1996 - as.numeric(subset(hrs, !is.na(match(hrs$HHIDPN, new_med$HHIDPN))==TRUE)$RABYEAR)) %>%
  subset(Age == 64)

## Re-plot
plot <- as.data.frame(matrix(rep(NA, 60), 20, 3)) 
colnames(plot) <- c("SPCFAC", "Year", "Value")
k <- 1
for(i in 4:13){
  year_sub <- select(new_med_age, ends_with(as.character(i)))
  for(j in 0:1){
    SPCFAC_sub <- subset(year_sub, year_sub[,1]==j)
    plot[k,] <- c(j, i, mean(SPCFAC_sub[,2], na.rm=TRUE))
    k <- k + 1
  }
}

plot$Value[is.na(plot$Value)] <- 0
plot$SPCFAC <- as.factor(plot$SPCFAC)
plot2 <- ggplot(plot, aes(x=Year, y=Value, fill=SPCFAC)) + geom_area()

grid.arrange(plot1, plot2, ncol=2)
```

We see that for all of these variables, the use of a health service (doctor, hospital, etc.) appears to be correlated with higher medical spending. The relationship between spending and nursing home, doctor and special facility are the most pronounced.  

## Investigation of Missing Values ##

Finally, we will examine the distribution of missing values within our sampled dataset. Since these observations were selected randomly, we will assume the percentage of missing values is representative of the dataset as a whole. We will begin by looking at the outcome variable:   

```{r echo=FALSE}
# OOPMD
dat <- wave_x_var("OOPMD")[,-1]
res <- colSums(is.na(dat))/5000*100
cat("Table 1: Percentage of NAs\n")
res[1:2] <- NA
res
```
There is a large number of missing values in all waves. The percentage of the missing values among the other variables of interest is similar. However, when you limit the data to observations from out selected sample with Medicare, the percentage drops drastically which suggests that the large numbers of NAs will not present a significant problem for modeling and the few missing values can be interpolated. 

```{r echo=FALSE}
### OOPMD with Medicare
dat <- wave_x_var("OOPMD")
with_medicare <- subset(dat, !is.na(match(dat$HHIDPN, new_med$HHIDPN))==TRUE)
res <- colSums(is.na(with_medicare))/5000*100
cat("Table 2: Percentage of NAs for Participants with Medicare\n")
res[1:2] <- NA
res
```

However, when we look at the percentage of missing values for observations across all waves of all considered variables we find that the average with-Medicare participant is missing 10 observations.   

```{r echo=FALSE}
new_med <- subset(hrs, !is.na(match(hrs$HHIDPN, t10$HHIDPN))==TRUE)
cat("Average NAs by Participant (with Medicare):\n")
mean(rowSums(is.na(new_med)))
cat("\n")
cat("Percentage of NAs by Participant (with Medicare)\n")
missing <- factor(cut(rowSums(is.na(new_med)),seq(0, 25, by=5)))
round(table(missing)/203, 2)
```

